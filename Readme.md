# DataSetupOracle POC - Karate Database Testing

## Overview
Create a POC demonstrating Karate framework testing of Oracle database procedures.  The database will
be running in a test container.

## Technology Stack
- **Language**: Java17
- **Build Tool**: Gradle
- **Database**: Oracle Free
- **JDBC Driver**: ojdbc11
- **Testing Framework**: Karate (karate labs)

These are high-level instructions for a POC that uses karate (karatelabs) for setting up data in an Oracle database. 
And built with Gradle.
The example should use a feature file to call a stored procedure in the oracle database.

## Database Schema

### Table: USERS
| Column   | Type         | Constraints                         |
|----------|--------------|-------------------------------------|
| id       | Number       | primary key (generated by sequence) |
| USERNAME | VARCHAR2(50) | not null                            |
| AGE      | NUMBER(3)    | NOT NULL                            |

### Sequences
- `USER_ID_SEQ` - generates primary keys for USERS.id

### Subprograms

1. Procedure **INSERT_USER**
   - Parameters: IN username VARCHAR2(40), IN age NUMBER, OUT primaryKey NUMBER
   - Behavior: Inserts a new user; error if username already exists

2. Function **GET_USER**
   - Parameters: IN username VARCHAR2(40)
   - Returns: result as sys_refcursor
   - Behavior: empty set if user doesn't exist

3. Procedure **DELETE_USER**
   - Parameters: IN username VARCHAR2(40), OUT rows_deleted.
   - Behavior: Deletes user if exists

#### Error Handling
- **Duplicate username in INSERT_USER**: Let Oracle raise UNIQUE constraint violation exception
- **Non-existent user in GET_USER**: Return empty cursor (not an error - handle gracefully)
- **Non-existent user in DELETE_USER**: Set rows_deleted = 0 (not an error - handle gracefully)

## Project Structure
The feature file should be placed in src/test/resources/features/ and should test the following:
a user can be added to the database with a given age.
a user can be removed from the database.

src/
    main/
        java/
            (empty for this POC)
        resources/
            (empty)
    test/
        java/
            testrunner/
                KarateTests.java (JUnit test runner)
            testcontainers/
                OracleContainerSetup.java (test container)
            database/
                UserOperations.java (helper class for database operations)
        resources/
            features/
                user-operations/
                    user-operations.feature
            karate-config.js
            db/
                01_schema.sql
                02_procedures.sql

### Database Helper
Create `src/test/java/database/UserOperations.java`:
- Method: `callInsertUser(connection, username, age)` → returns ID
- Method: `callGetUser(connection, username)` → returns ResultSet as List<Map>
  Note: Unwrap the SYS_REFCURSOR and convert to List<Map<String, Object>>
- Method: `callDeleteUser(connection, username)` → returns count
These will be called from feature files via `Java.type('database.UserOperations')`

## Implementation Requirements
### JUnit Test Runner
Add a JUnit test runner class in `src/test/java` to run the Karate feature files.  For example:

```java
package testrunner;

import com.intuit.karate.junit5.Karate;
import org.junit.jupiter.api.Test;

class KarateTests {

    @Test
    Karate testAll() {
        return Karate.run("classpath:features");
    }
}
```
### Database Connection
- The Oracle database will be running in a test container.

### Karate Configuration
- Create `karate-config.js` in `src/test/resources/`

### SQL Scripts
- Create SQL scripts in: `src/test/resources/db/`
    - `01_schema.sql` - CREATE TABLE statement
    - `02_procedures.sql` - All stored procedure definitions
- Scripts should be executed during test container initialization
- Use Testcontainers' `withInitScript()` method or similar

### Karate Integration Approach
Karate calls stored procedures directly via JDBC

### Feature File Test Cases

The `user-operations.feature` file should test:

1. **Scenario: Add a new user**
   - Call insert_user('john_doe', 25)
   - Call get_user('john_doe') and verify age is 25
   - Cleanup: delete_user('john_doe')

2. **Scenario: Delete an existing user**
   - Setup: insert_user('jane_doe', 30)
   - Call delete_user('jane_doe')
   - Verify: get_user('jane_doe') returns empty result set
   - Cleanup if needed

3. **Optional negative tests** (specify if needed):
   - Insert duplicate user (should fail)
   - Get non-existent user returns empty result set (should handle gracefully)
   - Delete non-existent user (should handle gracefully)

## Success Criteria
- Feature file executes successfully
- All test scenarios pass
- Database operations work correctly through stored procedures
- Clean test isolation (no data pollution between tests)

## Environment Setup Notes
- AI should create the stored procedures as SQL scripts
- Schema creation should be automated

## Gradle Dependencies
implementation 'com.oracle.database.jdbc:ojdbc11:23.9.0.25.07'
testImplementation 'io.karatelabs:karate-junit5:1.5.2.RC5'
testImplementation 'io.karatelabs:karate-core:1.5.2.RC5'
testImplementation 'org.testcontainers:oracle-free:1.21.3'

### Gradle Plugins Section
sourceCompatibility = '17'
targetCompatibility = '17'
plugins {
    id 'java'
}

test {
    useJUnitPlatform()
    systemProperty 'karate.options', System.properties.getProperty('karate.options')
}

## Docker
- Docker Image: gvenzl/oracle-free

## Running the Tests
- Run `gradle test`
- Testcontainer will start automatically
- Feature files will execute against the containerized Oracle database
- Container will shut down after tests complete

### Oracle Container Setup
Create `src/test/java/testcontainers/OracleContainerSetup.java`:
- Start container with @BeforeAll (static method)
- Execute SQL scripts via withInitScript()
- Store JDBC URL in static field
- Stop container with @AfterAll

In karate-config.js:
- Access container URL via Java.type('testcontainers.OracleContainerSetup').getJdbcUrl()