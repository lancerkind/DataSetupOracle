# DataSetupOracle POC - Karate Database Testing

## Overview
Create a POC demonstrating Karate framework testing of Oracle database procedures.  The database will
be running in a test container.

## Technology Stack
- **Language**: Java17
- **Build Tool**: Gradle
- **Database**: Oracle Free
- **JDBC Driver**: ojdbc11
- **Testing Framework**: Karate (karate labs)

These are high-level instructions for a POC that uses karate (karatelabs) for setting up data in an Oracle database. 
And built with Gradle.
The example should use a feature file to call a stored procedure in the oracle database.

## Database Schema

### Table: USERS
| Column   | Type         | Constraints                         |
|----------|--------------|-------------------------------------|
| id       | Number       | primary key (generated by sequence) |
| USERNAME | VARCHAR2(50) | not null                            |
| AGE      | NUMBER(3)    | NOT NULL                            |

### Sequences
- `USER_ID_SEQ` - generates primary keys for USERS.id

### Subprograms

1. Procedure **INSERT_USER**
   - Parameters: IN username VARCHAR2(40), IN age NUMBER, OUT primaryKey NUMBER
   - Behavior: Inserts a new user; error if username already exists

2. Function **GET_USER**
   - Parameters: IN username VARCHAR2(40)
   - Returns: result as sys_refcursor
   - Behavior: empty set if user doesn't exist

3. Procedure **DELETE_USER**
   - Parameters: IN username VARCHAR2(40), OUT rows_deleted.
   - Behavior: Deletes user if exists

#### Error Handling
- **Duplicate username in INSERT_USER**: Let Oracle raise UNIQUE constraint violation exception
- **Non-existent user in GET_USER**: Return empty cursor (not an error - handle gracefully)
- **Non-existent user in DELETE_USER**: Set rows_deleted = 0 (not an error - handle gracefully)

## Project Structure
The feature file should be placed in src/test/resources/features/ and should test the following:
a user can be added to the database with a given age.
a user can be removed from the database.

src/
    main/
        java/
            (empty for this POC)
        resources/
            (empty)
    test/
        java/
            testrunner/
                KarateTests.java (JUnit test runner)
            testcontainers/
                OracleContainerSetup.java (test container)
            database/
                UserOperations.java (helper class for database operations)
        resources/
            features/
                user-operations/
                    user-operations.feature
            karate-config.js
            db/
                01_schema.sql
                02_procedures.sql

### Database Helper
Create `src/test/java/database/UserOperations.java`:
- Method: `callInsertUser(connection, username, age)` → returns ID
- Method: `callGetUser(connection, username)` → returns ResultSet as List<Map>
  Note: Unwrap the SYS_REFCURSOR and convert to List<Map<String, Object>>
- Method: `callDeleteUser(connection, username)` → returns count
These will be called from feature files via `Java.type('database.UserOperations')`

## Implementation Requirements
### JUnit Test Runner
Add a JUnit test runner class in `src/test/java` to run the Karate feature files.  For example:

```java
package testrunner;

import com.intuit.karate.junit5.Karate;
import org.junit.jupiter.api.Test;

class KarateTests {

    @Test
    Karate testAll() {
        return Karate.run("classpath:features");
    }
}
```
### Database Connection
- The Oracle database will be running in a test container.

### Karate Configuration
- Create `karate-config.js` in `src/test/resources/`

### SQL Scripts
- Create SQL scripts in: `src/test/resources/db/`
    - `01_schema.sql` - CREATE TABLE statement
    - `02_procedures.sql` - All stored procedure definitions
- Scripts should be executed during test container initialization
- Use Testcontainers' `withInitScript()` method or similar

### Karate Integration Approach
Karate calls stored procedures directly via JDBC

### Feature File Test Cases

The `user-operations.feature` file should test:

1. **Scenario: Add a new user**
   - Call insert_user('john_doe', 25)
   - Call get_user('john_doe') and verify age is 25
   - Cleanup: delete_user('john_doe')

2. **Scenario: Delete an existing user**
   - Setup: insert_user('jane_doe', 30)
   - Call delete_user('jane_doe')
   - Verify: get_user('jane_doe') returns empty result set
   - Cleanup if needed

3. **Optional negative tests** (specify if needed):
   - Insert duplicate user (should fail)
   - Get non-existent user returns empty result set (should handle gracefully)
   - Delete non-existent user (should handle gracefully)

## Success Criteria
- Feature file executes successfully
- All test scenarios pass
- Database operations work correctly through stored procedures
- Clean test isolation (no data pollution between tests)

## Environment Setup Notes
- AI should create the stored procedures as SQL scripts
- Schema creation should be automated

## Gradle Dependencies
implementation 'com.oracle.database.jdbc:ojdbc11:23.9.0.25.07'
testImplementation 'io.karatelabs:karate-junit5:1.5.2.RC5'
testImplementation 'io.karatelabs:karate-core:1.5.2.RC5'
testImplementation 'org.testcontainers:oracle-free:1.21.3'

### Gradle Plugins Section
sourceCompatibility = '17'
targetCompatibility = '17'
plugins {
    id 'java'
}

test {
    useJUnitPlatform()
    systemProperty 'karate.options', System.properties.getProperty('karate.options')
}

## Docker
- Docker Image: gvenzl/oracle-free

## Running the Tests
- Run `gradle test`
- Testcontainer will start automatically
- Feature files will execute against the containerized Oracle database
- Container will shut down after tests complete

### Oracle Container Setup
Create `src/test/java/testcontainers/OracleContainerSetup.java`:
- Start container with @BeforeAll (static method)
- Execute SQL scripts via withInitScript()
- Store JDBC URL in static field
- Stop container with @AfterAll

In karate-config.js:
- Access container URL via Java.type('testcontainers.OracleContainerSetup').getJdbcUrl()

# Resources
API documentation: 
https://javadoc.io/doc/io.karatelabs
https://karatelabs.github.io/karate/


# Troubleshooting
## Question: although karate is looking for a features directory on the classpath and I have 
"features.somearea" in intelliJ, how is it finding my feature files?
### Answer: In certain circumstances Intellij really is using a directory structure beneath that is "./features/somearea/".
You'll need to look at the file structure to see what's really going on.

## Problem: Karate tests fail and I'm unclear why.
### Solution: See the test report out and "click in" until you get to staketrace.
Test report is listed on the last line displayed by the test runner.  For example:
file:///Users/<user>/IdeaProjects/DataSetupOracle/build/reports/tests/test/index.html

## The test report output has too much chatter from the test container to be practical. How can I reduce that?
### Confirm that test/resources/logback-test.xml is configured for ERROR level logging.  Confirm that a logslf4j implementation is provided, such as:
```gradle
testImplementation 'ch.qos.logback:logback-classic:1.5.20
```

## Problem: Testcontainer fails to start. Test execution logs (mentioned in stack trace that it's located at: file:///Users/<user>/IdeaProjects/DataSetupOracle/build/reports/tests/test/index.html) show: /Users/<user>/.docker/run/docker.sock' does not exist.
Which is created when Docker Desktop is *running*.
```text
09:15:40.110 [Test worker] DEBUG org.testcontainers.utility.TestcontainersConfiguration -- Testcontainers configuration overrides will be loaded from file:/Users/lancer/.testcontainers.properties
09:15:40.119 [Test worker] DEBUG org.testcontainers.utility.TestcontainersConfiguration -- Attempted to read Testcontainers configuration file at file:/Users/lancer/.testcontainers.properties but the file was not found. Exception message: FileNotFoundException: /Users/lancer/.testcontainers.properties (No such file or directory)
09:15:40.120 [Test worker] INFO org.testcontainers.images.PullPolicy -- Image pull policy will be performed by: DefaultPullPolicy()
09:15:40.121 [Test worker] INFO org.testcontainers.utility.ImageNameSubstitutor -- Image name substitution will be performed by: DefaultImageNameSubstitutor (composite of 'ConfigurationFileImageNameSubstitutor' and 'PrefixingImageNameSubstitutor')
09:15:40.124 [Test worker] INFO org.testcontainers.DockerClientFactory -- Testcontainers version: 1.21.3
09:15:40.212 [Test worker] DEBUG org.testcontainers.dockerclient.DockerClientProviderStrategy -- Trying out strategy: UnixSocketClientProviderStrategy
09:15:40.213 [Test worker] DEBUG org.testcontainers.dockerclient.DockerClientProviderStrategy -- UnixSocketClientProviderStrategy: failed with exception InvalidConfigurationException (Could not find unix domain socket). Root cause NoSuchFileException (/var/run/docker.sock)
09:15:40.214 [Test worker] DEBUG org.testcontainers.dockerclient.DockerClientProviderStrategy -- Trying out strategy: DockerDesktopClientProviderStrategy
09:15:40.214 [Test worker] DEBUG org.testcontainers.dockerclient.DockerDesktopClientProviderStrategy -- '/Users/lancer/.docker/desktop' does not exist.
09:15:40.215 [Test worker] DEBUG org.testcontainers.dockerclient.DockerDesktopClientProviderStrategy -- '/Users/lancer/.docker/run/docker.sock' does not exist.
09:15:40.215 [Test worker] DEBUG org.testcontainers.dockerclient.DockerClientProviderStrategy -- DockerDesktopClientProviderStrategy: failed with exception NullPointerException (Cannot invoke "java.nio.file.Path.toString()" because the return value of "org.testcontainers.dockerclient.DockerDesktopClientProviderStrategy.getSocketPath()" is null)
09:15:40.216 [Test worker] INFO org.testcontainers.dockerclient.DockerMachineClientProviderStrategy -- docker-machine executable was not found on PATH ([/Users/lancer/.nvm/versions/node/v22.18.0/bin, /Library/Frameworks/Python.framework/Versions/3.12/bin, /usr/local/bin, /System/Cryptexes/App/usr/bin, /usr/bin, /bin, /usr/sbin, /sbin, /var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin, /var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin, /var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin, /opt/X11/bin, /Library/Apple/usr/bin, /usr/local/git/bin, /usr/local/bin])
09:15:40.216 [Test worker] ERROR org.testcontainers.dockerclient.DockerClientProviderStrategy -- Could not find a valid Docker environment. Please check configuration. Attempted configurations were:
UnixSocketClientProviderStrategy: failed with exception InvalidConfigurationException (Could not find unix domain socket). Root cause NoSuchFileException (/var/run/docker.sock)
DockerDesktopClientProviderStrategy: failed with exception NullPointerException (Cannot invoke "java.nio.file.Path.toString()" because the return value of "org.testcontainers.dockerclient.DockerDesktopClientProviderStrategy.getSocketPath()" is null)As no valid configuration was found, execution cannot continue.
See https://java.testcontainers.org/on_failure.html for more details.
```
### Solution:
Start Docker Desktop.